<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fiesta Survival ULTIMATE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            background-color: #050510;
            color: white;
            font-family: 'Orbitron', sans-serif;
            /* Fuente futurista/neon */
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            box-shadow: none;
            /* Removed for full screen */
            border-radius: 0;
            /* Removed for full screen */
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        canvas {
            display: block;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
        }

        /* UI Hud con Glassmorphism - DESKTOP BASE */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            pointer-events: none;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            /* Left, Center, Right */
            gap: 15px;
            align-items: start;
            z-index: 10;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 12px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        .progress-track {
            background: rgba(0, 0, 0, 0.6);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            height: 100%;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* Brillo sutil en las barras */
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.3) 50%, rgba(255, 255, 255, 0) 100%);
        }

        #life-bar {
            background: linear-gradient(90deg, #ff3e3e, #ff0055);
            box-shadow: 0 0 10px #ff0055;
            width: 100%;
        }

        #drunk-bar {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            box-shadow: 0 0 10px #00d2ff;
            width: 0%;
        }

        /* Level Indicator */
        #level-display {
            position: absolute;
            top: 80px;
            /* Debajo del HUD superior pero visible */
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: 40px;
            font-weight: bold;
            color: #f1c40f;
            text-shadow: 0 0 20px #f1c40f, 0 0 40px red;
            opacity: 0;
            /* Invisible por defecto, aparece al subir nivel */
            transition: opacity 0.5s, transform 0.5s;
            pointer-events: none;
            z-index: 15;
            white-space: nowrap;
        }

        #current-level-small {
            /* Now part of the flow */
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #ccc;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #555;
            text-transform: uppercase;
            white-space: nowrap;
            margin: 0 5px;
        }

        #hud-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        #hud-bottom-row {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 5px;
        }

        /* Pantallas (Start / Game Over) */
        .overlay-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            transition: opacity 0.5s;
        }

        h1 {
            font-size: 50px;
            margin: 0;
            background: linear-gradient(to right, #ff00cc, #3333ff);
            background: linear-gradient(to right, #ff00cc, #3333ff);
            background-clip: text;
            /* Fix lint */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(51, 51, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 5px;
            text-align: center;
        }

        p {
            color: #ccc;
            font-size: 18px;
            margin-top: 10px;
        }

        button {
            margin-top: 30px;
            background: linear-gradient(45deg, #ff00cc, #3333ff);
            border: none;
            padding: 15px 40px;
            color: white;
            font-family: inherit;
            font-size: 20px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 0, 204, 0.4);
            transition: all 0.3s;
            text-transform: uppercase;
        }

        button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 40px rgba(255, 0, 204, 0.8);
        }

        #controls {
            margin-top: 20px;
            font-size: 14px;
            opacity: 0.7;
        }

        /* Responsive Mobile Styles */
        /* MOBILE OPTIMIZED HUD */
        @media (max-width: 600px) {
            #hud {
                padding: 5px 10px;
                background: rgba(0, 0, 0, 0.3);
                /* Subtle backdrop */
                backdrop-filter: blur(5px);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .stat-box {
                padding: 5px;
                background: none;
                border: none;
                box-shadow: none;
                width: 100%;
                max-width: none;
            }

            .stat-label {
                font-size: 10px;
                margin-bottom: 2px;
            }

            .progress-track {
                height: 6px;
                background: rgba(0, 0, 0, 0.8);
            }

            #score-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            #score-val {
                font-size: 24px !important;
                line-height: 1;
            }

            #score-label {
                font-size: 8px;
                opacity: 0.8;
                letter-spacing: 2px;
            }

            #current-level-small {
                font-size: 10px;
                padding: 2px 6px;
                margin-top: 2px;
                background: none;
                border: none;
                color: #f1c40f;
            }
        }
    </style>
</head>

<body>

    <div id="game-container">
        <!-- HUD -->
        <div id="hud">
            <!-- LEFT: HEALTH -->
            <div class="stat-box">
                <div class="stat-label">
                    <span style="color: #ff3e3e;">‚ù§ SALUD</span>
                    <span id="life-val">100%</span>
                </div>
                <div class="progress-track">
                    <div id="life-bar" class="progress-bar"></div>
                </div>
            </div>

            <!-- CENTER: SCORE & LEVEL -->
            <div id="score-container" style="text-align: center;">
                <div id="score-label" style="font-size: 10px; color: #00ffff; letter-spacing: 2px;">KILLS</div>
                <div id="score-val"
                    style="font-size: 30px; font-weight: bold; color: white; text-shadow: 0 0 10px #00ffff;">0</div>
                <div id="current-level-small" style="font-size: 12px; color: #f1c40f; margin-top: 5px;">NIVEL 1</div>
            </div>

            <!-- RIGHT: DRUNK -->
            <div class="stat-box" style="text-align: right;">
                <div class="stat-label">
                    <span id="drunk-val">0%</span>
                    <span style="color: #00d2ff;">EBRIEDAD üç∫</span>
                </div>
                <div class="progress-track">
                    <div id="drunk-bar" class="progress-bar"></div>
                </div>
            </div>
        </div>

        <div id="level-display">TERRAZAS</div>

        <!-- Pantalla Inicio -->
        <div id="start-screen" class="overlay-screen">
            <h1>Neon Party<br><small style="font-size: 30px;">Fiesta en SIL</small></h1>
            <p>Ayuda a Damaris a esquivar el alcohol y tomar agua.</p>
            <div id="controls">‚Üê Mover Izquierda | Mover Derecha ‚Üí</div>
            <button onclick="startGame()">¬°A BAILAR!</button>
        </div>

        <!-- Pantalla Game Over -->
        <div id="game-over" class="overlay-screen" style="display: none;">
            <h1 style="font-size: 50px; color: #ff3e3e;">CIMA ET√çLICA</h1>
            <p id="final-score">Sobreviviste X segundos</p>
            <button onclick="startGame()">OTRA RONDA</button>
        </div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        /**
         * FIESTA SURVIVAL - VERSION PRO
         * Mejoras: Sistema de part√≠culas, iluminaci√≥n, dificultad progresiva, f√≠sicas suaves.
         */

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // Optimizaci√≥n

        // Elementos UI
        const ui = {
            lifeBar: document.getElementById('life-bar'),
            lifeVal: document.getElementById('life-val'),
            drunkBar: document.getElementById('drunk-bar'),
            drunkVal: document.getElementById('drunk-val'),
            levelDisplay: document.getElementById('level-display'),
            levelSmall: document.getElementById('current-level-small'),
            startScreen: document.getElementById('start-screen'),
            startScreen: document.getElementById('start-screen'),
            gameOverScreen: document.getElementById('game-over'),
            finalScore: document.getElementById('final-score'),
            scoreVal: document.getElementById('score-val')
        };

        // --- ASSETS GENERADOS ---
        function createGlowingSprite(emoji, size, colorGlow) {
            const c = document.createElement('canvas');
            const s = size * 2.5; // Margen para el glow extra
            c.width = s;
            c.height = s;
            const cx = c.getContext('2d');

            // Glow intenso
            cx.shadowColor = colorGlow;
            cx.shadowBlur = 25;
            cx.font = `${size}px Arial`;
            cx.textAlign = 'center';
            cx.textBaseline = 'middle';
            cx.fillText(emoji, s / 2, s / 2);

            return c;
        }

        const SPRITES = {
            player: loadImage('images/damaris.png'), // User provided image
            cantina: createGlowingSprite('üëΩ', 70, '#f1c40f'),
            // Items (Local PNGs)
            copaVino: loadImage('images/copa vino.png'),
            copaWisky: loadImage('images/copa wisky.png'),
            botellaCorona: loadImage('images/botella corona.png'),
            botellaVino: loadImage('images/botella vino.png'),
            botellaWisky: loadImage('images/botella wisky.png'),
            gotaAgua: loadImage('images/gota agua.png'),
            limon: loadImage('images/limon.png'),
            botellaAgua: loadImage('images/botella agua.png')
        };

        function loadImage(src) {
            const img = new Image();
            img.src = src;
            return img;
        }

        // --- ESTADO GLOBAL ---
        let gameRunning = false;
        let lastTime = 0;

        const GAME = {
            width: window.innerWidth,
            height: window.innerHeight,
            life: 100,
            drunk: 0,
            time: 0,
            level: 1,
            score: 0
        };

        // Auto resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            GAME.width = canvas.width;
            GAME.height = canvas.height;

            // Keep player on screen if resized
            if (PLAYER.y > GAME.height - 100) PLAYER.y = GAME.height - 100;
            if (PLAYER.x > GAME.width) PLAYER.x = GAME.width - 50;
        });

        // Init canvas size immediately
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const LEVEL_NAMES = ["", "NIVEL 1: TERRAZAS", "NIVEL 2: LOS LOROS", "NIVEL 3: EUREKA"];

        const PLAYER = {
            x: 0, y: 0,
            w: 60, h: 60,
            vx: 0, vy: 0, speed: 600,
            friction: 0.9,
            vx: 0, vy: 0, speed: 600,
            friction: 0.9,
            targetX: 0,
            doubleShotTimer: 0
        };

        const CANTINA = {
            x: 0, y: 40,
            w: 80, h: 80,
            speed: 200,
            phase: 0
        };

        let entities = [];
        let particles = [];
        let bullets = [];
        let floatingTexts = [];

        // --- INPUT ---
        const keys = { left: false, right: false, up: false, down: false };
        window.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') keys.left = true;
            if (e.key === 'ArrowRight') keys.right = true;
            if (e.key === 'ArrowUp') keys.up = true;
            if (e.key === 'ArrowDown') keys.down = true;
        });
        window.addEventListener('keyup', e => {
            if (e.key === 'ArrowLeft') keys.left = false;
            if (e.key === 'ArrowRight') keys.right = false;
            if (e.key === 'ArrowUp') keys.up = false;
            if (e.key === 'ArrowDown') keys.down = false;
        });

        // --- CONTROLES T√ÅCTILES (MOBILE) ---
        let touchInputX = null;
        let touchInputY = null;

        window.addEventListener('touchstart', e => {
            if (!gameRunning) return; // Allow buttons to work
            e.preventDefault();
            touchInputX = e.touches[0].clientX;
            touchInputY = e.touches[0].clientY;
        }, { passive: false });

        window.addEventListener('touchmove', e => {
            if (!gameRunning) return;
            e.preventDefault();
            touchInputX = e.touches[0].clientX;
            touchInputY = e.touches[0].clientY;
        }, { passive: false });

        window.addEventListener('touchend', e => {
            if (!gameRunning) return;
            e.preventDefault();
            touchInputX = null;
            touchInputY = null;
        }, { passive: false });

        // --- SISTEMA DE PART√çCULAS ---
        class Particle {
            constructor(x, y, color, speed, size) {
                this.x = x; this.y = y;
                this.color = color;
                this.size = size;
                const angle = Math.random() * Math.PI * 2;
                const vel = Math.random() * speed;
                this.vx = Math.cos(angle) * vel;
                this.vy = Math.sin(angle) * vel;
                this.life = 1.0;
                this.decay = 0.02 + Math.random() * 0.03;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                this.size *= 0.95;
            }
            draw(ctx) {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        class FloatingText {
            constructor(x, y, text, color, size = 20) {
                this.x = x; this.y = y;
                this.text = text;
                this.color = color;
                this.size = size;
                this.life = 1.0;
                this.vy = -1.5;
            }
            update() {
                this.y += this.vy;
                this.life -= 0.015;
            }
            draw(ctx) {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.font = `bold ${this.size}px Arial`;
                ctx.fillText(this.text, this.x, this.y);
                ctx.globalAlpha = 1.0;
            }
        }

        function spawnExplosion(x, y, color, big = false) {
            const count = big ? 30 : 15;
            const size = big ? 8 : 5;
            const speed = big ? 8 : 5;
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, color, speed, Math.random() * size + 2));
            }
        }

        // --- LOGICA PRINCIPAL ---

        function startGame() {
            gameRunning = true;
            GAME.life = 100;
            GAME.life = 100;
            GAME.drunk = 0;
            GAME.time = 0;
            GAME.score = 0;
            GAME.level = 1;
            entities = [];
            particles = [];
            bullets = [];
            floatingTexts = [];

            PLAYER.x = GAME.width / 2;
            PLAYER.y = GAME.height - 100;

            ui.startScreen.style.display = 'none';
            ui.gameOverScreen.style.display = 'none';

            showLevelUp(1); // Force show level 1

            lastTime = performance.now();
            requestAnimationFrame(loop);
        }

        function showLevelUp(level) {
            const name = LEVEL_NAMES[level] || `NIVEL ${level}`;

            ui.levelDisplay.innerText = `${name}`;
            ui.levelDisplay.style.opacity = 1;
            ui.levelDisplay.style.transform = "translateX(-50%) scale(1.2)";

            setTimeout(() => {
                ui.levelDisplay.style.opacity = 0;
                ui.levelDisplay.style.transform = "translateX(-50%) scale(1)";
            }, 3000);

            ui.levelSmall.innerText = `${name}`;
        }

        function update(dt) {
            GAME.time += dt;

            // 1. Dificultad Din√°mica por Tiempo
            const oldLevel = GAME.level;

            // Ajustamos tiempos para los 3 niveles
            // Ajustamos niveles por SCORE (KILLS)
            // Lvl 1 -> 2: 15 Kills
            // Lvl 2 -> 3: 40 Kills
            if (GAME.score < 15) GAME.level = 1;
            else if (GAME.score < 40) GAME.level = 2;
            else GAME.level = 3;

            // Si supera el nivel 3, se queda en Eureka pero se vuelve m√°s dif√≠cil
            // (level number se mantendr√° en 3 para el nombre, pero usaremos el tiempo para spawn rates)

            if (GAME.level > oldLevel) showLevelUp(GAME.level);

            // 2. Jugador
            if (touchInputX !== null) {
                // Direct Touch Control (Follow Finger)
                let targetX = touchInputX;
                let targetY = touchInputY || PLAYER.y; // Fallback if Y is missing for some reason

                // Drunk Wobble
                if (GAME.drunk > 50) {
                    targetX += Math.sin(Date.now() / 200) * (GAME.drunk * 0.8);
                }

                // Smooth movement towards finger
                PLAYER.x += (targetX - PLAYER.x) * 10 * dt;
                PLAYER.y += (targetY - PLAYER.y) * 10 * dt;

                // Update VX for physics feel (tilt)
                PLAYER.vx = (targetX - PLAYER.x) * 5;
                PLAYER.vx = (targetX - PLAYER.x) * 5;
                PLAYER.vy = (targetY - PLAYER.y) * 5;

                // --- AUTO FIRE (When touching) ---
                if (!PLAYER.shootTimer) PLAYER.shootTimer = 0;
                PLAYER.shootTimer -= dt;

                // Double Shot Timer
                if (PLAYER.doubleShotTimer > 0) PLAYER.doubleShotTimer -= dt;

                if (PLAYER.shootTimer <= 0) {
                    PLAYER.shootTimer = 0.15; // Fire rate

                    if (PLAYER.doubleShotTimer > 0) {
                        // DOUBLE SHOT
                        bullets.push({ x: PLAYER.x - 10, y: PLAYER.y - 30, w: 4, h: 15, speed: 800, color: '#f1c40f' }); // Gold/Yellow
                        bullets.push({ x: PLAYER.x + 10, y: PLAYER.y - 30, w: 4, h: 15, speed: 800, color: '#f1c40f' });
                    } else {
                        // Single Shot
                        bullets.push({ x: PLAYER.x, y: PLAYER.y - 30, w: 4, h: 15, speed: 800, color: '#00ffff' }); // Neon Cyan
                    }
                }
            } else {
                // Keyboard Control
                let inputDirX = 0;
                let inputDirY = 0;

                if (keys.left) inputDirX = -1;
                if (keys.right) inputDirX = 1;
                if (keys.up) inputDirY = -1;
                if (keys.down) inputDirY = 1;

                if (GAME.drunk > 85 && Math.random() < 0.1) inputDirX *= -1;

                PLAYER.vx += inputDirX * PLAYER.speed * dt * 5;
                PLAYER.vy += inputDirY * PLAYER.speed * dt * 5; // Vertical speed same as horizontal

                PLAYER.vx *= PLAYER.friction;
                PLAYER.vy *= PLAYER.friction;

                PLAYER.x += PLAYER.vx * dt;
                PLAYER.y += PLAYER.vy * dt;
            }

            // Limites
            if (PLAYER.x < 30) { PLAYER.x = 30; PLAYER.vx *= -0.5; }
            if (PLAYER.x > GAME.width - 30) { PLAYER.x = GAME.width - 30; PLAYER.vx *= -0.5; }

            // Vertical Limits (Don't let them go too high into HUD or too low offscreen)
            if (PLAYER.y < 100) { PLAYER.y = 100; PLAYER.vy *= -0.5; } // Don't go above HUD area
            if (PLAYER.y > GAME.height - 50) { PLAYER.y = GAME.height - 50; PLAYER.vy *= -0.5; }

            // 3. Cantina (Boss)
            // Calculamos un "nivel de dificultad interno" que sigue subiendo aunque el nombre sea el mismo
            // 3. Cantina (Boss)
            // Calculamos un "nivel de dificultad interno" que sigue subiendo aunque el nombre sea el mismo
            // 3. Cantina (Boss)
            // Dificultad basada en Score + Tiempo (para que no se estanque)
            let difficultyFactor = (GAME.score / 15) + (GAME.time / 60);

            CANTINA.phase += dt * (1 + difficultyFactor * 0.5);
            let cantinaTargetX = (GAME.width / 2) + Math.sin(CANTINA.phase) * (GAME.width / 2 - 60);
            CANTINA.x += (cantinaTargetX - CANTINA.x) * 3 * dt;

            // SPAWNING
            // Rate depende de la dificultad interna
            const spawnRate = Math.max(0.15, 0.8 - (difficultyFactor * 0.2)); // Faster spawn rate cap
            if (Math.random() < (dt / spawnRate)) {
                spawnEntity(difficultyFactor);
                spawnBarrier(difficultyFactor); // Try to spawn barrier
                spawnBlade(difficultyFactor);   // Try to spawn SPINNING BLADE
            }

            // 4. Entidades
            for (let i = entities.length - 1; i >= 0; i--) {
                let e = entities[i];
                e.y += e.speed * dt;
                e.rotation += e.rotSpeed * dt;

                // Hitbox circular / Rectangular for barriers
                let hit = false;

                if (e.isBarrier) {
                    // Simple AABB collision for barriers
                    if (PLAYER.x > e.x - e.w / 2 - 20 && PLAYER.x < e.x + e.w / 2 + 20 &&
                        PLAYER.y > e.y - e.h / 2 - 20 && PLAYER.y < e.y + e.h / 2 + 20) {
                        hit = true;
                    }
                } else if (e.isBlade) {
                    // Circular hitbox for spinning blade
                    const dist = Math.hypot(e.x - PLAYER.x, e.y - PLAYER.y);
                    if (dist < 45) hit = true;
                } else {
                    const hitDist = (e.isGiant ? 50 : 35);
                    const dist = Math.hypot(e.x - PLAYER.x, e.y - PLAYER.y);
                    if (dist < hitDist) hit = true;
                }

                if (hit) { // Colisi√≥n
                    if (e.isBarrier) {
                        GAME.life -= 15;
                        GAME.drunk += 10;
                        spawnExplosion(PLAYER.x, PLAYER.y - 30, e.color, true);
                        floatingTexts.push(new FloatingText(PLAYER.x, PLAYER.y - 60, "-15!", e.color, 30));
                        PLAYER.y += 50; // Pushback
                    } else if (e.isBlade) {
                        // Blade Hit
                        GAME.life -= 20;
                        GAME.drunk += 5;
                        spawnExplosion(PLAYER.x, PLAYER.y, '#ff0000', true);
                        floatingTexts.push(new FloatingText(PLAYER.x, PLAYER.y - 60, "-20!!", '#ff0000', 40));
                        PLAYER.y += 80; // Massive Pushback
                        PLAYER.vx += (Math.random() - 0.5) * 1000; // Spin out
                    } else {
                        applyEffect(e);
                    }
                    entities.splice(i, 1);
                    continue;
                }

                if (e.y > GAME.height) entities.splice(i, 1);
            }

            // 5. Particulas
            particles.forEach((p, i) => {
                p.update();
                if (p.life <= 0) particles.splice(i, 1);
            });
            floatingTexts.forEach((t, i) => {
                t.update();
                if (t.life <= 0) floatingTexts.splice(i, 1);
            });

            updateUI();

            // 6. Bullets Update
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.y -= b.speed * dt;

                // Bullet Collision
                for (let j = entities.length - 1; j >= 0; j--) {
                    let e = entities[j];
                    if (e.y < 0) continue; // Don't hit offscreen

                    // Simple Box Collision
                    if (b.x > e.x - 30 && b.x < e.x + 30 &&
                        b.y > e.y - 30 && b.y < e.y + 30) {

                        const isEnemy = (e.type && e.type.dmg) || e.isBarrier || e.isBlade;
                        if (!isEnemy) continue; // Don't shoot friendly items

                        // Hit!
                        spawnExplosion(b.x, b.y, '#00ffff', false);
                        bullets.splice(i, 1); // Remove bullet

                        if (e.isBarrier || e.isBlade) {
                            // Sparks but no damage to barriers/blades (invincible?)
                            // User didn't specify, but usually obstacles are hard. 
                            // Let's make barriers destructible but HARD (10 HP)
                            if (!e.hp) e.hp = 10;
                            e.hp--;
                            if (e.hp <= 0) {
                                spawnExplosion(e.x, e.y, e.color, true);
                                floatingTexts.push(new FloatingText(e.x, e.y, "BOOM!", "#fff", 30));
                                entities.splice(j, 1);
                            }
                            break; // Bullet handled
                        }

                        // Alcohol Hit
                        e.hp--;
                        if (e.hp <= 0) {
                            // Destroyed
                            GAME.score++;
                            spawnExplosion(e.x, e.y, e.type.color, true);
                            floatingTexts.push(new FloatingText(e.x, e.y, "+1 Kill", "#fff", 20));
                            entities.splice(j, 1);
                        } else {
                            // Hit effect
                            e.y -= 10; // Knockback
                            floatingTexts.push(new FloatingText(e.x, e.y, "HIT", "#fff", 15));
                        }
                        break; // Bullet handled
                    }
                }
                if (b.y < -50) bullets.splice(i, 1);
            }
        }

        function spawnEntity(difficulty) {
            let type = {};
            let sprite = SPRITES.wine;
            let isGiant = Math.random() < 0.1;
            let isTurbo = Math.random() < 0.1; // 10% chance for TURBO speed

            let speed = 250 + (difficulty * 80); // Higher base speed
            if (isTurbo) speed *= 2.0; // DOUBLE SPEED

            let sizeScale = isGiant ? 1.8 : 1.0;

            // Probabilidades
            const rand = Math.random();
            // User requested MORE alcohol and LESS healing items.
            // Base chance for alcohol increased to 0.85 (was 0.60)
            const alcoholChance = 0.85 + (difficulty * 0.05);

            if (rand < Math.min(alcoholChance, 0.9)) {
                // ALCOHOL
                const r2 = Math.random();
                if (r2 < 0.25) {
                    // COPAS (Bajo efecto)
                    if (Math.random() < 0.5) {
                        sprite = SPRITES.copaVino;
                        type = { dmg: 5, drunk: 8, color: '#ff3e3e', name: 'Copa Vino' };
                    } else {
                        sprite = SPRITES.copaWisky;
                        type = { dmg: 6, drunk: 10, color: '#d35400', name: 'Copa Whisky' };
                    }
                } else if (r2 < 0.55) {
                    // CORONA (x2)
                    sprite = SPRITES.botellaCorona;
                    type = { dmg: 10, drunk: 16, color: '#f39c12', name: 'Corona' };
                } else if (r2 < 0.8) {
                    // BOTELLA VINO (x3)
                    sprite = SPRITES.botellaVino;
                    type = { dmg: 15, drunk: 24, color: '#e67e22', name: 'Botella Vino' };
                } else {
                    // BOTELLA WISKY (x4) - El m√°s fuerte
                    sprite = SPRITES.botellaWisky;
                    type = { dmg: 20, drunk: 32, color: '#8e44ad', name: 'Botella Whisky' };
                }
            } else {
                // AYUDAS
                const r3 = Math.random();

                // Lemon Rarity: Starts at 5%, increases by 2% per level (approx based on difficulty)
                // difficultyFactor is roughly 0..1..2..3
                const lemonChance = 0.05 + (difficulty * 0.02);

                if (r3 < lemonChance) {
                    // LIMON (RARE POWER UP: DOUBLE SHOT)
                    sprite = SPRITES.limon;
                    type = { heal: 15, sober: 20, color: '#f1c40f', name: 'Limon' };
                } else if (r3 < 0.6) {
                    // GOTA AGUA
                    sprite = SPRITES.gotaAgua;
                    type = { heal: 5, sober: 10, color: '#3498db', name: 'Gota Agua' };
                } else {
                    // BOTELLA AGUA
                    sprite = SPRITES.botellaAgua;
                    type = { heal: 25, sober: 40, color: '#00d2ff', name: 'Botella Agua' };
                }
            }

            // Origen
            let startX, startY;
            if (type.dmg) {
                startX = CANTINA.x + (Math.random() - 0.5) * 40;
                startY = CANTINA.y + 40;
            } else {
                startX = Math.random() * (GAME.width - 50) + 25;
                startY = -50;
            }

            entities.push({
                x: startX,
                y: startY,
                sprite: sprite,
                type: type,
                isGiant: isGiant,
                hp: type.dmg ? (type.drunk < 10 ? 1 : Math.floor(type.drunk / 8)) : 999, // HP based on strength
                scale: sizeScale,
                speed: speed + Math.random() * 80,
                rotation: Math.random() * Math.PI,
                rotSpeed: (Math.random() - 0.5) * 4
            });
        }

        // --- OBSTACULOS (MUROS) ---
        function spawnBarrier(difficulty) {
            // Chance increases with difficulty
            if (Math.random() > (0.05 + difficulty * 0.05)) return;

            const barrierWidth = 150 + Math.random() * 100;
            const barrierX = Math.random() * (GAME.width - barrierWidth);

            entities.push({
                x: barrierX + barrierWidth / 2, // Center
                y: -50,
                w: barrierWidth,
                h: 30,
                isBarrier: true,
                speed: 300 + (difficulty * 60), // Faster barriers
                color: Math.random() < 0.5 ? '#ff00cc' : '#3333ff' // Macuahuitl neon colors
            });
        }

        // --- SPINNING BLADES ---
        function spawnBlade(difficulty) {
            // Low chance, but dangerous
            if (Math.random() > (0.02 + difficulty * 0.03)) return;

            const x = Math.random() * (GAME.width - 50) + 25;

            entities.push({
                x: x,
                y: -50,
                w: 50, h: 50,
                isBlade: true,
                speed: 350 + (difficulty * 100), // Very fast
                rotation: 0,
                rotSpeed: 10 + Math.random() * 10, // Spin fast
                color: '#ff0055'
            });
        }

        function applyEffect(e) {
            spawnExplosion(e.x, e.y, e.type.color, e.isGiant);

            let label = "";
            let color = e.type.color;

            if (e.type.dmg) {
                GAME.life -= e.type.dmg;
                GAME.drunk += e.type.drunk;
                label = `-${Math.round(e.type.dmg)}`;
            } else {
                GAME.life += e.type.heal;
                GAME.drunk -= e.type.sober;
                label = `+${Math.round(e.type.heal)}`;

                // Power up: Limon
                if (e.type.name === 'Limon') {
                    PLAYER.doubleShotTimer = 10;
                    floatingTexts.push(new FloatingText(e.x, e.y - 70, "DOUBLE SHOT!", "#f1c40f", 25));
                }
            }

            if (e.isGiant) label += "!";

            floatingTexts.push(new FloatingText(e.x, e.y - 40, label, color, e.isGiant ? 30 : 20));

            GAME.life = Math.min(100, Math.max(0, GAME.life));
            GAME.drunk = Math.min(100, Math.max(0, GAME.drunk));

            if (GAME.life <= 0) gameOver();
        }

        function gameOver() {
            gameRunning = false;
            let finalLvlName = LEVEL_NAMES[Math.min(GAME.level, LEVEL_NAMES.length - 1)];
            ui.gameOverScreen.style.display = 'flex';
            ui.finalScore.innerText = `DERRIBADOS: ${GAME.score}\nLUGAR: ${finalLvlName}`;
        }

        function updateUI() {
            ui.lifeBar.style.width = `${GAME.life}%`;
            ui.lifeVal.innerText = `${Math.floor(GAME.life)}%`;
            ui.drunkBar.style.width = `${GAME.drunk}%`;
            ui.drunkVal.innerText = `${Math.floor(GAME.drunk)}%`;

            if (GAME.life < 30) ui.lifeBar.style.filter = "brightness(1.5) drop-shadow(0 0 5px red)";
            else ui.lifeBar.style.filter = "none";

            ui.scoreVal.innerText = GAME.score;
        }

        // --- DRAW ---
        function draw() {
            ctx.fillStyle = '#050510';
            ctx.fillRect(0, 0, GAME.width, GAME.height);

            // Efecto Luces Disco
            if (gameRunning) {
                const time = Date.now() / 1000;
                for (let i = 0; i < 3; i++) {
                    const x = (Math.sin(time * (0.5 + i * 0.1) + i) * 0.5 + 0.5) * GAME.width;
                    const y = (Math.cos(time * (0.3 + i * 0.1) + i) * 0.5 + 0.5) * GAME.height;
                    const size = 200 + Math.sin(time) * 50;

                    const grad = ctx.createRadialGradient(x, y, 0, x, y, size);
                    const hue = (time * 20 + i * 60 + GAME.level * 30) % 360;

                    grad.addColorStop(0, `hsla(${hue}, 70%, 50%, 0.15)`);
                    grad.addColorStop(1, 'transparent');
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            ctx.save();
            if (GAME.drunk > 20) {
                const shake = (GAME.drunk - 20) * 0.05;
                ctx.translate((Math.random() - 0.5) * shake, (Math.random() - 0.5) * shake);
            }

            particles.forEach(p => p.draw(ctx));

            // Draw Bullets
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ffff';
            ctx.fillStyle = '#00ffff';
            bullets.forEach(b => {
                ctx.fillRect(b.x - b.w / 2, b.y - b.h / 2, b.w, b.h);
            });
            ctx.shadowBlur = 0;

            ctx.shadowColor = '#f1c40f';
            ctx.shadowBlur = 20;
            ctx.drawImage(SPRITES.cantina, CANTINA.x - 40, CANTINA.y - 40);
            ctx.shadowBlur = 0;

            entities.forEach(e => {
                ctx.save();
                ctx.translate(e.x, e.y);

                if (e.isBarrier) {
                    // Draw Neon Barrier
                    ctx.fillStyle = e.color;
                    ctx.shadowColor = e.color;
                    ctx.shadowBlur = 20;
                    ctx.fillRect(-e.w / 2, -e.h / 2, e.w, e.h);

                    // Stripe pattern
                    ctx.fillStyle = "rgba(0,0,0,0.3)";
                    for (let i = -e.w / 2; i < e.w / 2; i += 20) {
                        ctx.fillRect(i, -e.h / 2, 10, e.h);
                    }

                    ctx.restore();
                    return;
                }

                if (e.isBlade) {
                    // Draw Neon Blade (Cross)
                    ctx.shadowColor = e.color || '#ff0055';
                    ctx.shadowBlur = 15;
                    ctx.fillStyle = e.color || '#ff0055';

                    // Cross shape
                    ctx.fillRect(-25, -5, 50, 10);
                    ctx.fillRect(-5, -25, 10, 50);

                    // Center glow
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(-2, -2, 4, 4);

                    ctx.restore();
                    return;
                }

                ctx.rotate(e.rotation);
                const scale = e.scale || 1.0;
                ctx.scale(scale, scale);
                // Force size to 60x60 regardless of source image size
                ctx.drawImage(e.sprite, -30, -30, 60, 60);
                ctx.restore();
            });

            const wobble = Math.sin(Date.now() / 150) * (GAME.drunk / 3);
            ctx.save();
            ctx.translate(PLAYER.x, PLAYER.y);

            // Name Tag
            ctx.font = "bold 14px Arial";
            ctx.fillStyle = "#ff00cc";
            ctx.textAlign = "center";
            ctx.fillText("DAMARIS", 0, -50);

            ctx.rotate(wobble * Math.PI / 180);
            ctx.shadowColor = '#ff00cc';
            ctx.shadowBlur = 15;
            // Force player size to 60x60
            ctx.drawImage(SPRITES.player, -30, -30, 60, 60);
            ctx.restore();

            floatingTexts.forEach(t => t.draw(ctx));

            ctx.restore();
        }

        function loop() {
            if (!gameRunning) return;
            const now = performance.now();
            const dt = Math.min((now - lastTime) / 1000, 0.1);
            lastTime = now;

            update(dt);
            draw();
            requestAnimationFrame(loop);
        }

        ctx.fillStyle = '#050510';
        ctx.fillRect(0, 0, 900, 600);
        ctx.font = "30px Orbitron";
        ctx.fillStyle = "white";
        ctx.textAlign = "center";

    </script>
</body>

</html>